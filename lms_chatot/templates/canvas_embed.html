<div id="canvas-ai-widget-root">
    <style>
        /* Widget Root & Scoped Variables */
        #canvas-ai-widget-root {
            --cai-primary: var(--ic-brand-primary, #0374B5);
            --cai-bg: #FFFFFF;
            --cai-bg-secondary: #F5F5F5;
            --cai-text: #2D3B45;
            --cai-text-light: #6B7780;
            --cai-border: #C7CDD1;
            --cai-hover: #F0F0F0;
            --cai-accent: var(--ic-brand-primary, #0374B5);

            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            font-family: 'Lato', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.5;
        }

        #canvas-ai-widget-root[data-theme="dark"] {
            --cai-bg: #2D3B45;
            --cai-bg-secondary: #394B58;
            --cai-text: #FFFFFF;
            --cai-text-light: #C7CDD1;
            --cai-border: #394B58;
            --cai-hover: #394B58;
        }

        /* Resets inside widget to prevent external styles from leaking in */
        #canvas-ai-widget-root * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border: none;
            outline: none;
        }

        #canvas-ai-widget-root button {
            background: none;
            cursor: pointer;
            font-family: inherit;
        }

        /* Widget Toggle Button - Hidden for iframe */
        #canvas-ai-widget-root .cai-toggle-btn {
            display: none;
        }

        /* Main App Container */
        #canvas-ai-widget-root .cai-app-container {
            width: 100%;
            height: 100vh;
            background: var(--cai-bg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: auto;
        }

        /* Sidebar */
        #canvas-ai-widget-root .cai-sidebar {
            width: 260px;
            background: var(--cai-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 1px 0 0 var(--cai-border);
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 10;
            border-right: 1px solid var(--cai-border);
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #canvas-ai-widget-root .cai-sidebar.active {
            transform: translateX(0);
        }

        #canvas-ai-widget-root .cai-sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #canvas-ai-widget-root .cai-sidebar.active~.cai-sidebar-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* Sidebar content */
        #canvas-ai-widget-root .cai-sidebar-header {
            padding: 16px;
            background: var(--cai-bg);
            color: var(--cai-text);
            border-bottom: 1px solid var(--cai-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #canvas-ai-widget-root .cai-sidebar-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--cai-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #canvas-ai-widget-root .cai-theme-toggle {
            width: 28px;
            height: 28px;
            background: transparent;
            color: var(--cai-text-light);
            border-radius: 3px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        #canvas-ai-widget-root .cai-theme-toggle:hover {
            background: var(--cai-hover);
            color: var(--cai-text);
        }

        #canvas-ai-widget-root .cai-new-chat-section {
            padding: 12px;
            border-bottom: 1px solid var(--cai-border);
        }

        #canvas-ai-widget-root .cai-new-chat-btn {
            width: 100%;
            padding: 8px 12px;
            background: transparent;
            color: var(--cai-accent);
            border-radius: 3px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border: 1px solid var(--cai-border);
        }

        #canvas-ai-widget-root .cai-new-chat-btn:hover {
            background: var(--cai-hover);
            border-color: var(--cai-accent);
        }

        #canvas-ai-widget-root .cai-conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            background: var(--cai-bg);
        }

        #canvas-ai-widget-root .cai-conversation-item {
            padding: 8px 12px;
            margin-bottom: 2px;
            border-radius: 3px;
            font-size: 13px;
            color: var(--cai-text);
            cursor: pointer;
            background: transparent;
            border: none;
        }

        #canvas-ai-widget-root .cai-conversation-item:hover {
            background: var(--cai-hover);
        }

        /* Chat Area */
        #canvas-ai-widget-root .cai-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--cai-bg);
            height: 100%;
            width: 100%;
        }

        #canvas-ai-widget-root .cai-chat-header {
            padding: 16px;
            background: var(--cai-bg);
            color: var(--cai-text);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 2;
            border-bottom: 1px solid var(--cai-border);
            flex-shrink: 0;
        }

        #canvas-ai-widget-root .cai-menu-btn {
            color: var(--cai-text-light);
            font-size: 18px;
            padding: 4px;
            margin-right: 10px;
            display: flex;
        }

        #canvas-ai-widget-root .cai-menu-btn:hover {
            color: var(--cai-text);
        }

        #canvas-ai-widget-root .cai-chat-header-text h2 {
            font-size: 15px;
            margin: 0;
            color: var(--cai-text);
            font-weight: 600;
        }

        #canvas-ai-widget-root .cai-chat-header-subtitle {
            font-size: 12px;
            color: var(--cai-text-light);
            font-weight: 400;
        }

        #canvas-ai-widget-root .cai-chat-box {
            flex: 1;
            padding: 16px;
            background: var(--cai-bg-secondary);
            overflow-y: auto;
            color: var(--cai-text);
        }

        #canvas-ai-widget-root .cai-message {
            margin-bottom: 16px;
            display: flex;
        }

        #canvas-ai-widget-root .cai-message-content {
            padding: 12px 14px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            max-width: 85%;
        }

        #canvas-ai-widget-root .cai-message.user {
            justify-content: flex-end;
        }

        #canvas-ai-widget-root .cai-message.user .cai-message-content {
            background: var(--cai-bg);
            color: var(--cai-text);
            border: 1px solid var(--cai-border);
        }

        #canvas-ai-widget-root .cai-message.assistant .cai-message-content {
            background: var(--cai-bg);
            color: var(--cai-text);
            border: 1px solid var(--cai-border);
        }

        #canvas-ai-widget-root .cai-input-area {
            padding: 16px;
            background: var(--cai-bg);
            border-top: 1px solid var(--cai-border);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        #canvas-ai-widget-root .cai-input-wrapper {
            flex: 1;
        }

        #canvas-ai-widget-root .cai-input-area textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid var(--cai-border);
            border-radius: 6px;
            background: var(--cai-bg);
            color: var(--cai-text);
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }

        #canvas-ai-widget-root .cai-input-area textarea:focus {
            outline: none;
            border-color: var(--cai-accent);
        }

        #canvas-ai-widget-root .cai-input-area button.cai-send-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: transparent;
            color: var(--cai-accent);
            border-radius: 6px;
            border: 1px solid var(--cai-border);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #canvas-ai-widget-root .cai-input-area button.cai-send-btn:hover {
            background: var(--cai-hover);
            border-color: var(--cai-accent);
        }

        /* Empty State */
        #canvas-ai-widget-root .cai-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 24px;
        }

        #canvas-ai-widget-root .cai-empty-icon {
            margin-bottom: 16px;
            color: var(--cai-text-light);
            opacity: 0.5;
        }

        #canvas-ai-widget-root .cai-empty-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--cai-text);
            font-size: 16px;
        }

        #canvas-ai-widget-root .cai-empty-sub {
            color: var(--cai-text-light);
            margin-bottom: 24px;
            font-size: 14px;
            font-weight: 400;
        }

        #canvas-ai-widget-root .cai-quick-actions {
            display: grid;
            width: 100%;
            max-width: 280px;
            gap: 8px;
        }

        #canvas-ai-widget-root .cai-quick-action-btn {
            padding: 12px 14px;
            font-size: 14px;
            background: var(--cai-bg);
            border: 1px solid var(--cai-border);
            border-radius: 6px;
            color: var(--cai-text);
            text-align: left;
            font-weight: 400;
            display: flex;
            align-items: center;
        }

        #canvas-ai-widget-root .cai-quick-action-btn:hover {
            border-color: var(--cai-accent);
            background: var(--cai-hover);
        }

        /* Thinking animation */
        #canvas-ai-widget-root .cai-thinking .cai-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: cai-bounce 1s infinite;
        }

        @keyframes cai-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        /* Error Banner */
        #canvas-ai-widget-root .cai-error-banner {
            padding: 12px;
            background: #fee2e2;
            color: #b91c1c;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 16px;
            border: 1px solid #fecaca;
        }

        /* Responsive */
        @media (max-width: 480px) {
            #canvas-ai-widget-root {
                bottom: 0;
                right: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }

            #canvas-ai-widget-root.open {
                pointer-events: auto;
            }

            #canvas-ai-widget-root .cai-app-container {
                width: 100%;
                height: 100%;
                bottom: 70px;
                border-radius: 16px 16px 0 0;
            }

            #canvas-ai-widget-root .cai-toggle-btn {
                bottom: 16px;
                right: 16px;
            }
        }
    </style>

    <!-- UI -->
    <div class="cai-app-container">
        <!-- Sidebar -->
        <div class="cai-sidebar" id="canvasAiSidebar">
            <div class="cai-sidebar-header">
                <h3>Conversations</h3>
                <button class="cai-theme-toggle" onclick="window.CanvasAI.toggleTheme()" title="Toggle dark mode">
                    <span id="caiThemeIcon">ðŸŒ™</span>
                </button>
            </div>
            <div class="cai-new-chat-section">
                <button class="cai-new-chat-btn" onclick="window.CanvasAI.startNewChat()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Chat
                </button>
            </div>
            <div class="cai-conversations-list" id="caiConversationsList"></div>
        </div>

        <!-- Overlay to close sidebar -->
        <div class="cai-sidebar-overlay" onclick="window.CanvasAI.toggleSidebar()"></div>

        <!-- Chat -->
        <div class="cai-chat-container">
            <div class="cai-chat-header">
                <div class="cai-chat-header-text" style="display: flex; align-items: center;">
                    <button class="cai-menu-btn" onclick="window.CanvasAI.toggleSidebar()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div>
                        <h2>AI Assistant</h2>
                        <div class="cai-chat-header-subtitle">Canvas LMS Helper</div>
                    </div>
                </div>
            </div>

            <div class="cai-chat-box" id="caiChatBox">
                <!-- Content injected via JS -->
            </div>

            <div class="cai-input-area">
                <div class="cai-input-wrapper">
                    <textarea id="caiUserInput" placeholder="Ask me anything..." rows="1"></textarea>
                </div>
                <button id="caiSendBtn" class="cai-send-btn" onclick="window.CanvasAI.sendMessage()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            // Prevent duplicate injection
            if (window.CanvasAI) return;

            // Configuration
            const CONFIG = {
                API_BASE: window.location.origin,
                ROOT_ID: 'canvas-ai-widget-root'
            };

            // State
            const state = {
                messages: [],
                sessionId: null,
                canvasUserId: null,
                userRole: 'student',
                username: 'Guest',
                currentConversationId: null,
                conversations: [],
                isOpen: false,
                isSidebarOpen: false
            };

            // Initialize Context
            function initContext() {
                const env = window.ENV || {};

                state.canvasUserId = env.current_user_id || localStorage.getItem('canvas_ai_user_id');
                state.username = (env.current_user) ? env.current_user.display_name : (localStorage.getItem('canvas_ai_username') || 'Student');

                if (env.current_user_roles && env.current_user_roles.some(r => ['teacher', 'admin', 'designer'].includes(r))) {
                    state.userRole = 'teacher';
                } else {
                    state.userRole = 'student';
                }

                if (state.canvasUserId) localStorage.setItem('canvas_ai_user_id', state.canvasUserId);
                if (state.username) localStorage.setItem('canvas_ai_username', state.username);

                // Load persistent theme
                const savedTheme = localStorage.getItem('canvas_ai_theme') || 'light';
                document.getElementById('canvas-ai-widget-root').setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);

                // Don't load conversation on init - wait for Canvas context

                console.log('Canvas AI Widget Initialized', state);
            }

            // Listen for Canvas context from parent
            window.addEventListener('message', (event) => {
                if (event.data.source === 'canvas') {
                    const previousUserId = state.canvasUserId;
                    
                    state.canvasUserId = event.data.canvas_user_id;
                    state.userRole = event.data.user_role || 'student';
                    state.username = event.data.username || 'Canvas User';
                    
                    // User changed - clear conversation
                    if (previousUserId && previousUserId !== state.canvasUserId) {
                        state.messages = [];
                        state.currentConversationId = null;
                        state.sessionId = null;
                    }
                    
                    localStorage.setItem('canvas_ai_user_id', state.canvasUserId);
                    localStorage.setItem('canvas_ai_username', state.username);
                    
                    const root = document.getElementById('canvas-ai-widget-root');
                    
                    if (event.data.theme) {
                        root.setAttribute('data-theme', event.data.theme);
                        localStorage.setItem('canvas_ai_theme', event.data.theme);
                        updateThemeIcon(event.data.theme);
                    }
                    
                    if (event.data.theme_colors) {
                        const colors = event.data.theme_colors;
                        if (colors.primary) root.style.setProperty('--ic-brand-primary', colors.primary);
                        if (colors.secondary) root.style.setProperty('--ic-brand-button--primary-bgd', colors.secondary);
                        if (colors.font) root.style.setProperty('--ic-brand-font-color-dark', colors.font);
                        if (colors.link) root.style.setProperty('--ic-link-color', colors.link);
                        if (colors.background) root.style.setProperty('--ic-brand-global-nav-bgd', colors.background);
                    }
                    
                    // Load last conversation for this user
                    if (!previousUserId || previousUserId !== state.canvasUserId) {
                        const lastConversationId = localStorage.getItem(`canvas_ai_last_conversation_${state.canvasUserId}`);
                        if (lastConversationId) {
                            loadConversation(lastConversationId);
                        } else {
                            renderEmptyState();
                        }
                    }
                    
                    console.log('Received Canvas context:', state);
                }
            });

            window.CanvasAI = {
                toggleSidebar: function () {
                    const sidebar = document.getElementById('canvasAiSidebar');
                    state.isSidebarOpen = !state.isSidebarOpen;
                    if (state.isSidebarOpen) {
                        sidebar.classList.add('active');
                        loadConversations();
                    } else {
                        sidebar.classList.remove('active');
                    }
                },

                toggleTheme: function () {
                    const root = document.getElementById(CONFIG.ROOT_ID);
                    const current = root.getAttribute('data-theme');
                    const next = current === 'dark' ? 'light' : 'dark';

                    root.setAttribute('data-theme', next);
                    localStorage.setItem('canvas_ai_theme', next);
                    updateThemeIcon(next);
                },

                startNewChat: function () {
                    state.currentConversationId = null;
                    state.messages = [];
                    localStorage.removeItem(`canvas_ai_last_conversation_${state.canvasUserId}`);
                    renderEmptyState();
                    window.CanvasAI.toggleSidebar();
                    createNewConversation();
                },

                sendMessage: sendMessage,
                quickAction: function (text) {
                    const input = document.getElementById('caiUserInput');
                    input.value = text;
                    sendMessage();
                }
            };

            function updateThemeIcon(theme) {
                const icon = document.getElementById('caiThemeIcon');
                if (icon) icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            }

            async function createNewConversation() {
                if (!state.canvasUserId || isConfigInvalid()) return;
                try {
                    const res = await fetch(`${CONFIG.API_BASE}/conversations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ canvas_user_id: state.canvasUserId, title: 'New Chat' })
                    });
                    const data = await res.json();
                    state.currentConversationId = data.conversation_id;
                } catch (e) {
                    console.error('Failed to init chat', e);
                }
            }

            async function loadConversations() {
                if (!state.canvasUserId || isConfigInvalid()) return;
                try {
                    const res = await fetch(`${CONFIG.API_BASE}/conversations?canvas_user_id=${state.canvasUserId}`);
                    const data = await res.json();
                    state.conversations = data.conversations || [];

                    const list = document.getElementById('caiConversationsList');
                    list.innerHTML = '';

                    state.conversations.forEach(conv => {
                        const item = document.createElement('div');
                        item.className = 'cai-conversation-item';
                        item.innerHTML = `<strong>${conv.title || 'Untitled'}</strong><br><small>${new Date(conv.created_at).toLocaleDateString()}</small>`;
                        item.onclick = () => loadConversation(conv.id);
                        list.appendChild(item);
                    });
                } catch (e) {
                    console.error('Failed to load conversations', e);
                    const list = document.getElementById('caiConversationsList');
                    list.innerHTML = '<div style="padding:10px; font-size:12px; opacity:0.7">Connect error</div>';
                }
            }

            async function loadConversation(id) {
                state.currentConversationId = id;
                localStorage.setItem(`canvas_ai_last_conversation_${state.canvasUserId}`, id);
                window.CanvasAI.toggleSidebar();

                try {
                    const res = await fetch(`${CONFIG.API_BASE}/conversations/${id}/messages?canvas_user_id=${state.canvasUserId}`);
                    const data = await res.json();
                    state.messages = data.messages || [];
                    renderMessages();
                } catch (e) {
                    console.error('Failed to load messages', e);
                }
            }

            function renderMessages() {
                const box = document.getElementById('caiChatBox');
                box.innerHTML = '';
                state.messages.forEach(msg => appendMessage(msg.role, msg.content));
                box.scrollTop = box.scrollHeight;
            }

            function appendMessage(role, content) {
                const box = document.getElementById('caiChatBox');
                const div = document.createElement('div');
                div.className = `cai-message ${role}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'cai-message-content';
                
                // Convert markdown-like formatting
                let html = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                
                contentDiv.innerHTML = html;
                div.appendChild(contentDiv);
                box.appendChild(div);
            }

            function isConfigInvalid() {
                return CONFIG.API_BASE.includes('example.com');
            }

            function renderEmptyState() {
                const box = document.getElementById('caiChatBox');
                let quickActionsHtml = `
                <button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('List my courses')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:6px">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    List my courses
                </button>
                <button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('Show my assignments')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:6px">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    My assignments
                </button>
                <button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('Help me get started')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:6px">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Get help
                </button>
            `;

                if (state.userRole === 'teacher' || state.userRole === 'admin') {
                    quickActionsHtml += `<button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('Create a new course')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline-block;vertical-align:middle;margin-right:6px">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Create course
                    </button>`;
                }

                let warningHtml = '';

                box.innerHTML = `
                <div class="cai-empty-state">
                    <div class="cai-empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <div class="cai-empty-title">Hi, ${state.username}</div>
                    <div class="cai-empty-sub">How can I help you with Canvas today?</div>
                    ${warningHtml}
                    <div class="cai-quick-actions">
                        ${quickActionsHtml}
                    </div>
                </div>
            `;
            }

            async function sendMessage() {
                const input = document.getElementById('caiUserInput');
                const txt = input.value.trim();
                if (!txt) return;

                appendMessage('user', txt);
                state.messages.push({ role: 'user', content: txt });
                input.value = '';
                input.style.height = 'auto';

                const box = document.getElementById('caiChatBox');
                const thinking = document.createElement('div');
                thinking.className = 'cai-message assistant';
                thinking.innerHTML = `<div class="cai-message-content cai-thinking"><span class="cai-dot"></span><span class="cai-dot"></span><span class="cai-dot"></span></div>`;
                box.appendChild(thinking);
                box.scrollTop = box.scrollHeight;

                try {
                    const res = await fetch(`${CONFIG.API_BASE}/inference`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: state.messages,
                            canvas_user_id: state.canvasUserId,
                            user_role: state.userRole,
                            conversation_id: state.currentConversationId,
                            session_id: state.sessionId
                        })
                    });

                    if (!res.ok) {
                        throw new Error(`Server returned ${res.status}`);
                    }

                    const data = await res.json();
                    thinking.remove();

                    if (data.session_id) state.sessionId = data.session_id;
                    if (data.conversation_id) {
                        state.currentConversationId = data.conversation_id;
                        localStorage.setItem(`canvas_ai_last_conversation_${state.canvasUserId}`, data.conversation_id);
                    }

                    appendMessage('assistant', data.content);
                    state.messages.push({ role: 'assistant', content: data.content });

                    // Update message count to prevent duplicate notifications
                    localStorage.setItem(`canvas_ai_last_message_count_${state.canvasUserId}`, state.messages.length.toString());

                    if (state.messages.length <= 2) loadConversations();

                } catch (e) {
                    thinking.remove();
                    appendMessage('assistant', `âš ï¸ Connection failed: ${e.message}. Check console/SSL config.`);
                    console.error(e);
                }

                input.focus();
            }

            // Notify parent window of new messages
            function notifyParent() {
                if (window.parent !== window) {
                    window.parent.postMessage({ hasNewMessages: true }, '*');
                }
            }

            // Listen for check message requests from parent
            window.addEventListener('message', (event) => {
                if (event.data.action === 'checkNewMessages') {
                    const lastCount = parseInt(localStorage.getItem(`canvas_ai_last_message_count_${state.canvasUserId}`) || '0');
                    if (state.messages.length > lastCount) {
                        notifyParent();
                    }
                } else if (event.data.action === 'updateMessageCount') {
                    localStorage.setItem(`canvas_ai_last_message_count_${state.canvasUserId}`, state.messages.length.toString());
                }
            });

            // Update message count when widget is visible
            window.addEventListener('focus', () => {
                localStorage.setItem(`canvas_ai_last_message_count_${state.canvasUserId}`, state.messages.length.toString());
            });

            initContext();
            if (state.messages.length === 0) renderEmptyState();
            
            // Initialize message count
            localStorage.setItem(`canvas_ai_last_message_count_${state.canvasUserId}`, state.messages.length.toString());

            const input = document.getElementById('caiUserInput');
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

        })();
    </script>
</div>