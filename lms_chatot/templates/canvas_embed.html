<div id="canvas-ai-widget-root">
    <style>
        /* Widget Root & Scoped Variables */
        #canvas-ai-widget-root {
            --cai-bg-gradient-start: var(--ic-brand-primary, #667eea);
            --cai-bg-gradient-end: var(--ic-brand-primary-darkened-10, #764ba2);
            --cai-sidebar-gradient-start: var(--ic-brand-primary, #1e3a8a);
            --cai-sidebar-gradient-end: var(--ic-brand-primary-darkened-5, #1e40af);
            --cai-sidebar-border: rgba(255, 255, 255, 0.1);
            --cai-chat-bg: var(--ic-brand-global-nav-bgd, #ffffff);
            --cai-chat-box-bg-start: var(--ic-bg-light-primary, #f8fafc);
            --cai-chat-box-bg-end: var(--ic-bg-light-secondary, #f1f5f9);
            --cai-message-assistant-bg: var(--ic-bg-light-primary, #ffffff);
            --cai-message-assistant-border: var(--ic-border-light, #e5e7eb);
            --cai-text-primary: var(--ic-brand-font-color-dark, #1f2937);
            --cai-text-secondary: var(--ic-hint-text, #6b7280);
            --cai-input-bg: var(--ic-bg-light-primary, #f9fafb);
            --cai-input-border: var(--ic-border-light, #e5e7eb);
            --cai-new-chat-accent: #10b981;

            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: normal;
        }

        #canvas-ai-widget-root[data-theme="dark"] {
            --cai-bg-gradient-start: var(--ic-brand-primary, #1e293b);
            --cai-bg-gradient-end: var(--ic-brand-primary-darkened-10, #0f172a);
            --cai-sidebar-gradient-start: var(--ic-brand-global-nav-bgd, #0f172a);
            --cai-sidebar-gradient-end: var(--ic-brand-global-nav-menu-item__background, #1e293b);
            --cai-sidebar-border: rgba(255, 255, 255, 0.05);
            --cai-chat-bg: var(--ic-brand-global-nav-bgd, #1e293b);
            --cai-chat-box-bg-start: var(--ic-bg-dark, #0f172a);
            --cai-chat-box-bg-end: var(--ic-bg-dark-secondary, #1e293b);
            --cai-message-assistant-bg: var(--ic-bg-dark-secondary, #334155);
            --cai-message-assistant-border: var(--ic-border-dark, #475569);
            --cai-text-primary: var(--ic-brand-font-color-dark-lightened-15, #f1f5f9);
            --cai-text-secondary: var(--ic-hint-text, #94a3b8);
            --cai-input-bg: var(--ic-bg-dark-secondary, #334155);
            --cai-input-border: var(--ic-border-dark, #475569);
            --cai-new-chat-accent: #10b981;
        }

        /* Resets inside widget to prevent external styles from leaking in */
        #canvas-ai-widget-root * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border: none;
            outline: none;
        }

        #canvas-ai-widget-root button {
            background: none;
            cursor: pointer;
            font-family: inherit;
        }

        /* Widget Toggle Button - Hidden for iframe */
        #canvas-ai-widget-root .cai-toggle-btn {
            display: none;
        }

        /* Main App Container */
        #canvas-ai-widget-root .cai-app-container {
            width: 100%;
            height: 100vh;
            background: var(--cai-chat-bg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: auto;
        }

        /* Sidebar */
        #canvas-ai-widget-root .cai-sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--cai-sidebar-gradient-start) 0%, var(--cai-sidebar-gradient-end) 100%);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 10;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #canvas-ai-widget-root .cai-sidebar.active {
            transform: translateX(0);
        }

        #canvas-ai-widget-root .cai-sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #canvas-ai-widget-root .cai-sidebar.active~.cai-sidebar-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* Sidebar content */
        #canvas-ai-widget-root .cai-sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.15);
            color: white;
            border-bottom: 1px solid var(--cai-sidebar-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #canvas-ai-widget-root .cai-sidebar-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        #canvas-ai-widget-root .cai-theme-toggle {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #canvas-ai-widget-root .cai-new-chat-section {
            padding: 16px;
        }

        #canvas-ai-widget-root .cai-new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--cai-new-chat-accent) 0%, #059669 100%);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #canvas-ai-widget-root .cai-conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        #canvas-ai-widget-root .cai-conversation-item {
            padding: 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            font-size: 14px;
            color: white;
            cursor: pointer;
        }

        #canvas-ai-widget-root .cai-conversation-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Chat Area */
        #canvas-ai-widget-root .cai-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--cai-chat-bg);
            height: 100%;
            width: 100%;
        }

        #canvas-ai-widget-root .cai-chat-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 2;
        }

        #canvas-ai-widget-root .cai-menu-btn {
            color: white;
            font-size: 20px;
            padding: 4px;
            margin-right: 12px;
            display: flex;
        }

        #canvas-ai-widget-root .cai-chat-header-text h2 {
            font-size: 16px;
            margin: 0;
            color: white;
        }

        #canvas-ai-widget-root .cai-chat-header-subtitle {
            font-size: 11px;
            opacity: 0.8;
            color: rgba(255, 255, 255, 0.9);
        }

        #canvas-ai-widget-root .cai-chat-box {
            flex: 1;
            padding: 16px;
            background: linear-gradient(180deg, var(--cai-chat-box-bg-start) 0%, var(--cai-chat-box-bg-end) 100%);
            overflow-y: auto;
            color: var(--cai-text-primary);
        }

        #canvas-ai-widget-root .cai-message {
            margin-bottom: 16px;
            display: flex;
        }

        #canvas-ai-widget-root .cai-message-content {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
        }

        #canvas-ai-widget-root .cai-message.user {
            justify-content: flex-end;
        }

        #canvas-ai-widget-root .cai-message.user .cai-message-content {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
        }

        #canvas-ai-widget-root .cai-message.assistant .cai-message-content {
            background: var(--cai-message-assistant-bg);
            color: var(--cai-text-primary);
            border: 1px solid var(--cai-message-assistant-border);
        }

        #canvas-ai-widget-root .cai-input-area {
            padding: 16px;
            background: var(--cai-chat-bg);
            border-top: 1px solid var(--cai-input-border);
            display: flex;
            gap: 8px;
        }

        #canvas-ai-widget-root .cai-input-wrapper {
            flex: 1;
        }

        #canvas-ai-widget-root .cai-input-area textarea {
            width: 100%;
            padding: 12px 16px;
            font-size: 13px;
            border: 1px solid var(--cai-input-border);
            border-radius: 20px;
            background: var(--cai-input-bg);
            color: var(--cai-text-primary);
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }

        #canvas-ai-widget-root .cai-input-area button.cai-send-btn {
            padding: 0 20px;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
        }

        /* Empty State */
        #canvas-ai-widget-root .cai-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }

        #canvas-ai-widget-root .cai-empty-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        #canvas-ai-widget-root .cai-empty-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--cai-text-primary);
        }

        #canvas-ai-widget-root .cai-empty-sub {
            color: var(--cai-text-secondary);
            margin-bottom: 20px;
            font-size: 13px;
        }

        #canvas-ai-widget-root .cai-quick-actions {
            display: grid;
            width: 100%;
            max-width: 260px;
            gap: 8px;
        }

        #canvas-ai-widget-root .cai-quick-action-btn {
            padding: 12px;
            font-size: 13px;
            background: var(--cai-chat-bg);
            border: 1px solid var(--cai-input-border);
            border-radius: 8px;
            color: var(--cai-text-primary);
            text-align: left;
        }

        #canvas-ai-widget-root .cai-quick-action-btn:hover {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }

        /* Thinking animation */
        #canvas-ai-widget-root .cai-thinking .cai-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: cai-bounce 1s infinite;
        }

        @keyframes cai-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        /* Error Banner */
        #canvas-ai-widget-root .cai-error-banner {
            padding: 12px;
            background: #fee2e2;
            color: #b91c1c;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 16px;
            border: 1px solid #fecaca;
        }

        /* Responsive */
        @media (max-width: 480px) {
            #canvas-ai-widget-root {
                bottom: 0;
                right: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }

            #canvas-ai-widget-root.open {
                pointer-events: auto;
            }

            #canvas-ai-widget-root .cai-app-container {
                width: 100%;
                height: calc(100% - 70px);
                bottom: 70px;
                border-radius: 16px 16px 0 0;
            }

            #canvas-ai-widget-root .cai-toggle-btn {
                bottom: 16px;
                right: 16px;
            }
        }
    </style>

    <!-- UI -->
    <div class="cai-app-container">
        <!-- Sidebar -->
        <div class="cai-sidebar" id="canvasAiSidebar">
            <div class="cai-sidebar-header">
                <h3>Conversations</h3>
                <button class="cai-theme-toggle" onclick="window.CanvasAI.toggleTheme()" title="Toggle dark mode">
                    <span id="caiThemeIcon">üåô</span>
                </button>
            </div>
            <div class="cai-new-chat-section">
                <button class="cai-new-chat-btn" onclick="window.CanvasAI.startNewChat()">
                    <span>‚ú®</span> New Chat
                </button>
            </div>
            <div class="cai-conversations-list" id="caiConversationsList"></div>
        </div>

        <!-- Overlay to close sidebar -->
        <div class="cai-sidebar-overlay" onclick="window.CanvasAI.toggleSidebar()"></div>

        <!-- Chat -->
        <div class="cai-chat-container">
            <div class="cai-chat-header">
                <div class="cai-chat-header-text" style="display: flex; align-items: center;">
                    <button class="cai-menu-btn" onclick="window.CanvasAI.toggleSidebar()">‚ò∞</button>
                    <div>
                        <h2>AI Assistant</h2>
                        <div class="cai-chat-header-subtitle">Canvas LMS Helper</div>
                    </div>
                </div>
                <div
                    style="font-size: 10px; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                    <span>Online</span>
                </div>
            </div>

            <div class="cai-chat-box" id="caiChatBox">
                <!-- Content injected via JS -->
            </div>

            <div class="cai-input-area">
                <div class="cai-input-wrapper">
                    <textarea id="caiUserInput" placeholder="Ask me anything..." rows="1"></textarea>
                </div>
                <button id="caiSendBtn" class="cai-send-btn" onclick="window.CanvasAI.sendMessage()">
                    <span>üöÄ</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            // Prevent duplicate injection
            if (window.CanvasAI) return;

            // Configuration
            const CONFIG = {
                API_BASE: window.location.origin,
                ROOT_ID: 'canvas-ai-widget-root'
            };

            // State
            const state = {
                messages: [],
                sessionId: null,
                canvasUserId: null,
                userRole: 'student',
                username: 'Guest',
                currentConversationId: null,
                conversations: [],
                isOpen: false,
                isSidebarOpen: false
            };

            // Initialize Context
            function initContext() {
                const env = window.ENV || {};

                state.canvasUserId = env.current_user_id || localStorage.getItem('canvas_ai_user_id');
                state.username = (env.current_user) ? env.current_user.display_name : (localStorage.getItem('canvas_ai_username') || 'Student');

                if (env.current_user_roles && env.current_user_roles.some(r => ['teacher', 'admin', 'designer'].includes(r))) {
                    state.userRole = 'teacher';
                } else {
                    state.userRole = 'student';
                }

                if (state.canvasUserId) localStorage.setItem('canvas_ai_user_id', state.canvasUserId);
                if (state.username) localStorage.setItem('canvas_ai_username', state.username);

                // Load persistent theme
                const savedTheme = localStorage.getItem('canvas_ai_theme') || 'light';
                document.getElementById('canvas-ai-widget-root').setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);

                console.log('Canvas AI Widget Initialized', state);
            }

            // Listen for Canvas context from parent
            window.addEventListener('message', (event) => {
                if (event.data.source === 'canvas') {
                    state.canvasUserId = event.data.canvas_user_id;
                    state.userRole = event.data.user_role || 'student';
                    state.username = event.data.username || 'Canvas User';
                    
                    localStorage.setItem('canvas_ai_user_id', state.canvasUserId);
                    localStorage.setItem('canvas_ai_username', state.username);
                    
                    const root = document.getElementById('canvas-ai-widget-root');
                    
                    if (event.data.theme) {
                        root.setAttribute('data-theme', event.data.theme);
                        localStorage.setItem('canvas_ai_theme', event.data.theme);
                        updateThemeIcon(event.data.theme);
                    }
                    
                    if (event.data.theme_colors) {
                        const colors = event.data.theme_colors;
                        if (colors.primary) root.style.setProperty('--ic-brand-primary', colors.primary);
                        if (colors.secondary) root.style.setProperty('--ic-brand-button--primary-bgd', colors.secondary);
                        if (colors.font) root.style.setProperty('--ic-brand-font-color-dark', colors.font);
                        if (colors.link) root.style.setProperty('--ic-link-color', colors.link);
                        if (colors.background) root.style.setProperty('--ic-brand-global-nav-bgd', colors.background);
                    }
                    
                    console.log('Received Canvas context:', state);
                    if (state.messages.length === 0) renderEmptyState();
                }
            });

            window.CanvasAI = {
                toggleSidebar: function () {
                    const sidebar = document.getElementById('canvasAiSidebar');
                    state.isSidebarOpen = !state.isSidebarOpen;
                    if (state.isSidebarOpen) {
                        sidebar.classList.add('active');
                        loadConversations();
                    } else {
                        sidebar.classList.remove('active');
                    }
                },

                toggleTheme: function () {
                    const root = document.getElementById(CONFIG.ROOT_ID);
                    const current = root.getAttribute('data-theme');
                    const next = current === 'dark' ? 'light' : 'dark';

                    root.setAttribute('data-theme', next);
                    localStorage.setItem('canvas_ai_theme', next);
                    updateThemeIcon(next);
                },

                startNewChat: function () {
                    state.currentConversationId = null;
                    state.messages = [];
                    renderEmptyState();
                    window.CanvasAI.toggleSidebar();
                    createNewConversation();
                },

                sendMessage: sendMessage,
                quickAction: function (text) {
                    const input = document.getElementById('caiUserInput');
                    input.value = text;
                    sendMessage();
                }
            };

            function updateThemeIcon(theme) {
                const icon = document.getElementById('caiThemeIcon');
                if (icon) icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }

            async function createNewConversation() {
                if (!state.canvasUserId || isConfigInvalid()) return;
                try {
                    const res = await fetch(`${CONFIG.API_BASE}/conversations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ canvas_user_id: state.canvasUserId, title: 'New Chat' })
                    });
                    const data = await res.json();
                    state.currentConversationId = data.conversation_id;
                } catch (e) {
                    console.error('Failed to init chat', e);
                }
            }

            async function loadConversations() {
                if (!state.canvasUserId || isConfigInvalid()) return;
                try {
                    const res = await fetch(`${CONFIG.API_BASE}/conversations?canvas_user_id=${state.canvasUserId}`);
                    const data = await res.json();
                    state.conversations = data.conversations || [];

                    const list = document.getElementById('caiConversationsList');
                    list.innerHTML = '';

                    state.conversations.forEach(conv => {
                        const item = document.createElement('div');
                        item.className = 'cai-conversation-item';
                        item.innerHTML = `<strong>${conv.title || 'Untitled'}</strong><br><small>${new Date(conv.created_at).toLocaleDateString()}</small>`;
                        item.onclick = () => loadConversation(conv.id);
                        list.appendChild(item);
                    });
                } catch (e) {
                    console.error('Failed to load conversations', e);
                    const list = document.getElementById('caiConversationsList');
                    list.innerHTML = '<div style="padding:10px; font-size:12px; opacity:0.7">Connect error</div>';
                }
            }

            async function loadConversation(id) {
                state.currentConversationId = id;
                window.CanvasAI.toggleSidebar();

                try {
                    const res = await fetch(`${CONFIG.API_BASE}/conversations/${id}/messages`);
                    const data = await res.json();
                    state.messages = data.messages || [];
                    renderMessages();
                } catch (e) {
                    console.error('Failed to load messages', e);
                }
            }

            function renderMessages() {
                const box = document.getElementById('caiChatBox');
                box.innerHTML = '';
                state.messages.forEach(msg => appendMessage(msg.role, msg.content));
                box.scrollTop = box.scrollHeight;
            }

            function appendMessage(role, content) {
                const box = document.getElementById('caiChatBox');
                const div = document.createElement('div');
                div.className = `cai-message ${role}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'cai-message-content';
                
                // Convert markdown-like formatting
                let html = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                
                contentDiv.innerHTML = html;
                div.appendChild(contentDiv);
                box.appendChild(div);
            }

            function isConfigInvalid() {
                return CONFIG.API_BASE.includes('example.com');
            }

            function renderEmptyState() {
                const box = document.getElementById('caiChatBox');
                let quickActionsHtml = `
                <button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('List my courses')">üìö List my courses</button>
                <button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('Show my assignments')">üìù My assignments</button>
                <button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('Help me get started')">‚ùì Get help</button>
            `;

                if (state.userRole === 'teacher' || state.userRole === 'admin') {
                    quickActionsHtml += `<button class="cai-quick-action-btn" onclick="window.CanvasAI.quickAction('Create a new course')">‚ûï Create course</button>`;
                }

                let warningHtml = '';

                box.innerHTML = `
                <div class="cai-empty-state">
                    <div class="cai-empty-icon">üëã</div>
                    <div class="cai-empty-title">Hi, ${state.username}</div>
                    <div class="cai-empty-sub">How can I help you with Canvas today?</div>
                    ${warningHtml}
                    <div class="cai-quick-actions">
                        ${quickActionsHtml}
                    </div>
                </div>
            `;
            }

            async function sendMessage() {
                const input = document.getElementById('caiUserInput');
                const txt = input.value.trim();
                if (!txt) return;

                appendMessage('user', txt);
                state.messages.push({ role: 'user', content: txt });
                input.value = '';
                input.style.height = 'auto';

                const box = document.getElementById('caiChatBox');
                const thinking = document.createElement('div');
                thinking.className = 'cai-message assistant';
                thinking.innerHTML = `<div class="cai-message-content cai-thinking"><span class="cai-dot"></span><span class="cai-dot"></span><span class="cai-dot"></span></div>`;
                box.appendChild(thinking);
                box.scrollTop = box.scrollHeight;

                try {
                    const res = await fetch(`${CONFIG.API_BASE}/inference`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: state.messages,
                            canvas_user_id: state.canvasUserId,
                            user_role: state.userRole,
                            conversation_id: state.currentConversationId,
                            session_id: state.sessionId
                        })
                    });

                    if (!res.ok) {
                        throw new Error(`Server returned ${res.status}`);
                    }

                    const data = await res.json();
                    thinking.remove();

                    if (data.session_id) state.sessionId = data.session_id;
                    if (data.conversation_id) state.currentConversationId = data.conversation_id;

                    appendMessage('assistant', data.content);
                    state.messages.push({ role: 'assistant', content: data.content });

                    if (state.messages.length <= 2) loadConversations();

                } catch (e) {
                    thinking.remove();
                    appendMessage('assistant', `‚ö†Ô∏è Connection failed: ${e.message}. Check console/SSL config.`);
                    console.error(e);
                }

                input.focus();
            }

            initContext();
            if (state.messages.length === 0) renderEmptyState();

            const input = document.getElementById('caiUserInput');
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

        })();
    </script>
</div>