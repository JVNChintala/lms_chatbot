Canvas LMS Agent – Tool Selection Reliability Refactor
Instructions for Amazon Q (VS Code)

PURPOSE
-------
This document defines mandatory rules and TODOs to refactor the Canvas LMS AI Agent
to achieve deterministic, reliable tool selection. It is written for Amazon Q with
knowledge cutoff <= 2024.

TARGET ARCHITECTURE
-------------------
User Message
  -> Intent Classification (NO TOOLS)
  -> Tool Gating (CODE CONTROLLED)
  -> Tool Argument Generation (LLM)
  -> Canvas Tool Execution
  -> Response Formatting (LLM)

CORE RULES
----------
1. LLMs must NOT decide which tools exist.
2. LLMs must NOT decide whether tools are required.
3. Tool selection must be deterministic and code-driven.
4. LLMs are only used for:
   - Intent classification
   - Argument filling
   - Response formatting

INTENT CLASSIFICATION
---------------------
- Add an intent classification step before any tool call.
- No tools allowed.
- Output MUST be strict JSON.
- One intent only.
- Include confidence score.

Example output:
{
  "intent": "list_courses",
  "confidence": 0.91,
  "needs_tool": true
}

INTENT REGISTRY
---------------
Create a central intent list in code:

INTENTS = [
  "list_courses",
  "get_course_details",
  "create_course",
  "list_assignments",
  "get_assignment",
  "grade_assignment",
  "general_question"
]

INTENT TO TOOL MAPPING
----------------------
Create a deterministic mapping:

INTENT_TOOL_MAP = {
  "list_courses": ["list_user_courses"],
  "create_course": ["create_course"],
  "list_assignments": ["list_assignments"],
  "get_assignment": ["get_assignment"],
  "grade_assignment": ["grade_assignment"]
}

Rules:
- One intent maps to max 1–2 tools.
- general_question must map to NO tools.

TOOL GATING
-----------
Replace role-based tool exposure with intent-based exposure.

Old:
CanvasTools.get_tool_definitions(user_role)

New:
CanvasTools.get_tools_for_intent(intent, user_role)

Only pass tools relevant to the detected intent.

FORCED TOOL EXECUTION
---------------------
If confidence >= threshold (e.g. 0.75):

DO NOT use:
tool_choice="auto"

USE:
tool_choice={
  "type": "function",
  "function": {"name": tool_name}
}

The model must ONLY fill arguments.

PROMPT RULES
------------
Intent Classifier Prompt:
- JSON only
- No explanations
- No tools
- Choose exactly one intent

Tool Argument Prompt:
- Explicitly name the tool
- Instruct the model to NOT answer in text
- Arguments only

FALLBACK POLICY
---------------
If:
- confidence < threshold
- intent == general_question
- no tool mapping exists

Then:
- Skip tool calling
- Respond conversationally
- Ask clarification if needed

RESPONSE FORMATTING
-------------------
- Final LLM call receives tool result JSON
- Converts to human-friendly text
- Must not expose raw JSON
- Must not call tools

ACCEPTANCE CRITERIA
-------------------
- Deterministic tool usage
- No incorrect Canvas API calls
- <= 1 tool call per request
- Small models safe for classification
- Easy to add new intents/tools

NON-GOALS
---------
- Do not redesign CanvasTools internals
- Do not add new Canvas APIs
- Do not rely on LLM reasoning for control flow
- Do not expose all tools at once

IMPLEMENTATION ORDER
--------------------
1. Add intent classification
2. Add intent registry
3. Add intent-tool mapping
4. Gate tools by intent
5. Force tool execution
6. Add fallback logic
